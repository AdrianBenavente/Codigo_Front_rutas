<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Usuarios</title>
    <link rel="stylesheet" href="../static/css/styles.css">
</head>
<body>
    <div class="navbar">
        <a href="login.html">Cargar Datos</a>
        <a href="map.html">Ver Mapa</a>
        <a href="listado_ubicaciones.html">Listado de Ubicaciones</a>
        <a href="usuarios.html">Gesti√≥n de Usuarios</a>
        <a href="#" onclick="logout()" style="float: right;">Cerrar Sesi√≥n</a>
    </div>

    <h1>Gesti√≥n de Usuarios</h1>

    <div class="form-container">
        <h2>Agregar Usuario</h2>
        <div class="form-group">
            <input type="text" id="nombre" placeholder="Nombre">
            <input type="text" id="usuario" placeholder="Usuario">
        </div>
        <div class="form-group">
            <input type="placa" id="placa" placeholder="Placa">
            <input type="text" id="telefono" placeholder="Tel√©fono">
        </div>
        <div class="form-group">
            <input type="password" id="contrase√±a" placeholder="Contrase√±a">
            <select id="rol">
                <option value="1">Administrador</option>
                <option value="2">Usuario</option>
            </select>
        </div>
        <button onclick="guardarUsuario()">Guardar</button>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Usuario</th>
                    <th>Placa</th>
                    <th>Tel√©fono</th>
                    <th>Rol</th>
                    <th>Activo</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="tablaUsuarios"></tbody>
        </table>
    </div>
    
    <script>


        //const API_BASE = "http://localhost:5000";
        
        const API_BASE = "https://rutaslintek.duckdns.org";

    function getCurrentUser() {
    const user = localStorage.getItem("user");
    return user ? JSON.parse(user) : null;
    }

    function isAdmin() {
    const user = getCurrentUser();
    return user && user.rol === 1;  // Suponiendo que 1 es admin
    }



    function getToken() {
        return localStorage.getItem("token");
    }

    // üîê Verifica si el usuario est√° autenticado (por ejemplo al cargar la p√°gina)
    function checkAuth() {
        const token = getToken();
        if (!token) {
            alert("Debes iniciar sesi√≥n.");
            window.location.href = "../index.html";  // Redirige al login
        }
    }

    // üîê Usar este helper para agregar el Authorization Header
    function fetchAuth(url, options = {}) {
        const token = getToken();
        return fetch(url, {
            ...options,
            headers: {
                ...options.headers,
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        });
    }

    function cargarUsuarios() {
    fetchAuth(`${API_BASE}/usuarios_tabla`)
        .then(response => response.json())
        .then(data => {
            let usuariosTabla = document.getElementById("tablaUsuarios");
            usuariosTabla.innerHTML = ""; 

            data.forEach(usuario => {
                let fila = document.createElement("tr");
                fila.innerHTML = `
                    <td>${usuario.nombre}</td>
                    <td>${usuario.usuario}</td>
                    <td>${usuario.placa || "No disponible"}</td>  
                    <td>${usuario.telefono || "No disponible"}</td>  
                    <td>${usuario.rol}</td>
                    <td>${usuario.activo}</td>
                    <td>
                        <button onclick="editarUsuario(${usuario.id}, '${usuario.nombre}', '${usuario.usuario}', '${usuario.placa || ''}', '${usuario.telefono || ''}', '${usuario.rol}')">Editar</button>
                        <button onclick="eliminarUsuario(${usuario.id})">Eliminar</button>
                    </td>
                `;
                usuariosTabla.appendChild(fila);
            });
        })
        .catch(error => console.error("Error cargando usuarios:", error));
    }

    
function guardarUsuario() {
    let nombre = document.getElementById("nombre").value.trim();
    let usuario = document.getElementById("usuario").value.trim();
    let placa = document.getElementById("placa").value.trim();  // üõ† Corregido aqu√≠
    let telefono = document.getElementById("telefono").value.trim();
    let contrase√±a = document.getElementById("contrase√±a").value.trim();
    let rol_id = document.getElementById("rol").value;

    if (!nombre || !usuario || !placa || !telefono || !contrase√±a || !rol_id) {
        alert("Todos los campos son obligatorios.");
        return;
    }

    // Validar formato de email
    let placaRegex = /^(.{1,9})-(.{1,9})$/;
    if (!placaRegex.test(placa)) {
        alert("Por favor, ingresa una placa v√°lida.");
        return;
    }

    fetchAuth(`${API_BASE}/usuarios/agregar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre, usuario, placa, telefono, contrase√±a, rol_id })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.mensaje);
            cargarUsuarios();
            setTimeout(() => location.reload(), 500); // Peque√±a espera antes de recargar
        } else {
            alert(data.mensaje);
        }
    })
    .catch(error => console.error("Error guardando usuario:", error));
}

function eliminarUsuario(id) {
    if (!confirm("¬øEst√°s seguro de que deseas eliminar este usuario?")) return;

    fetchAuth(`${API_BASE}/usuarios/eliminar/${id}`, {
        method: "DELETE"
    })
    .then(response => response.json())
    .then(result => {
        alert(result.message);
        cargarUsuarios(); // üîπ Recargar la tabla despu√©s de eliminar
        setTimeout(() => location.reload(), 500);
    })
    .catch(error => console.error("Error al eliminar usuario:", error));
}

function editarUsuario(id, nombre, usuario, placa, telefono, rol) {
    document.getElementById("nombre").value = nombre || "";
    document.getElementById("usuario").value = usuario || "";
    document.getElementById("placa").value = placa || "";
    document.getElementById("telefono").value = telefono || "";
    document.getElementById("contrase√±a").value = "";
    document.getElementById("rol").value = (rol === "Administrador") ? 1 : 2;

    let botonGuardar = document.querySelector("button[onclick='guardarUsuario()']");
    botonGuardar.textContent = "Actualizar Usuario";
    botonGuardar.setAttribute("onclick", `actualizarUsuario(${id})`);
}

function actualizarUsuario(id) {
    let nombre = document.getElementById("nombre").value.trim();
    let usuario = document.getElementById("usuario").value.trim();
    let placa = document.getElementById("placa").value.trim();
    let telefono = document.getElementById("telefono").value.trim();
    let contrase√±a = document.getElementById("contrase√±a").value.trim();
    let rol_id = document.getElementById("rol").value;

    if (!nombre || !usuario || !placa || !telefono || !rol_id) {
        alert("Todos los campos son obligatorios, excepto la contrase√±a.");
        return;
    }

    // Validar formato de email
    let placaRegex = /^(.{1,9})-(.{1,9})$/;
    if (!placaRegex.test(placa)) {
        alert("Por favor, ingresa una placa v√°lida.");
        return;
    }

    // Validar tel√©fono
    let telefonoRegex = /^[0-9]{7,15}$/;
    if (!telefonoRegex.test(telefono)) {
        alert("El n√∫mero de tel√©fono debe contener entre 7 y 15 d√≠gitos num√©ricos.");
        return;
    }

    let datos = { nombre, usuario, placa, telefono, rol_id };
    if (contrase√±a) {
        datos.contrase√±a = contrase√±a;
    }

    fetchAuth(`${API_BASE}/usuarios/editar/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
    })
    .then(response => response.json())
    .then(result => {
        alert(result.message);
        cargarUsuarios();
        setTimeout(() => location.reload(), 500);
    })
    .catch(error => console.error("Error al editar usuario:", error));
}

    document.addEventListener("DOMContentLoaded", () => {
        if (!isAdmin()) {
            alert("Acceso denegado.");
            window.location.href = "map.html";  // O la p√°gina que quieras redirigir
        }
            checkAuth();
            cargarUsuarios();
        });

    function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    window.location.href = "../index.html";  // o "./index.html" dependiendo tu estructura
}
    </script>
</body>
</html>
